<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
        body {
            font-size: 14px; /* Minska teckenstorleken */
            margin: 0; /* Ta bort standardmarginaler */
            padding: 0; /* Ta bort standardpadding */
        }

        #map { height: 50vh; width: 100%; } /* Minska kartans höjd */
        
        #input-container {
            margin: 10px; /* Minska marginalerna */
            display: flex;
            flex-direction: column;
            align-items: center; /* Centrera elementen */
        }

        #flight-info {
            margin: 10px; /* Minska marginalerna */
            padding: 5px; /* Minska padding */
            border: 1px solid #ccc;
            background: #f9f9f9;
            height: auto; /* Låt informationen ta den plats den behöver */
        }

        button {
            font-size: 14px; /* Öka knapptstorleken */
            padding: 10px; /* Öka padding */
            cursor: pointer; /* Ändra muspekaren till pekare */
        }

        input {
            font-size: 14px; /* Öka input-fältets storlek */
            padding: 5px; /* Minska padding */
            width: 90%; /* Gör input-fältet mer brett */
        }

        @media (max-width: 300px) { /* Specifik för Apple Watch */
            #input-container {
                margin: 5px; /* Minska marginalerna ännu mer */
            }
            #map {
                height: 40vh; /* Minska kartans höjd */
            }
            #flight-info {
                font-size: 12px; /* Justera textstorleken för information */
            }
        }
    </style>
</head>
<body>
    <div id="input-container">
        <label for="callsign">Enter Callsign:</label>
        <input type="text" id="callsign" placeholder="Enter callsign">
        <button onclick="fetchFlight()">Search Flight</button>
    </div>
    <div id="map"></div>
    <div id="flight-info">
        <h3>Flight Information</h3>
        <p id="info"></p>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([59.3293, 18.0686], 6); // Centered on Stockholm with zoom level 6
        var polyline; // Global polyline to update
        var marker; // Global marker for current position

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        function fetchFlight() {
            var callsign = document.getElementById('callsign').value.trim().toUpperCase(); // Trim spaces and ensure uppercase
            var username = 'turbomannen'; // Replace with your OpenSky username
            var password = 'dYjkuz-1muxqa-gawkax'; // Replace with your OpenSky password

            // Fetch state vector to get ICAO using callsign
            fetch(`https://opensky-network.org/api/states/all`, {
                headers: {
                    'Authorization': 'Basic ' + btoa(username + ':' + password)
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.states && data.states.length > 0) {
                    // Filtrera ut flyg med det angivna callsignet
                    var matchingStates = data.states.filter(state => {
                        return typeof state[1] === 'string' && state[1].trim() === callsign; // state[1] är callsign
                    });
                    
                    if (matchingStates.length > 0) {
                        var icao24 = matchingStates[0][0]; // ICAO24 är den första posten i den matchande staten
                        updateFlightInfo(matchingStates[0]); // Uppdatera flyginformation
                        fetchTrack(icao24);
                    } else {
                        alert("Flight not found or no data available for this callsign.");
                        document.getElementById('info').innerHTML = ''; // Rensa tidigare information
                    }
                } else {
                    alert("No states returned from API.");
                    document.getElementById('info').innerHTML = ''; // Rensa tidigare information
                }
            })
            .catch(error => console.error('Error fetching flight data:', error));
        }

        function fetchTrack(icao24) {
            var username = 'turbomannen'; // Replace with your OpenSky username
            var password = 'dYjkuz-1muxqa-gawkax'; // Replace with your OpenSky password

            // Fetch the live track for the flight using the ICAO24
            fetch(`https://opensky-network.org/api/tracks/all?icao24=${icao24}&time=0`, {
                headers: {
                    'Authorization': 'Basic ' + btoa(username + ':' + password)
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.path && data.path.length > 0) {
                    var latestTrack = data.path[data.path.length - 1]; // Ta den senaste datapunkten
                    var coordinates = latestTrack ? [[latestTrack[1], latestTrack[2]]] : []; // Ta den senaste positionen

                    if (coordinates.length > 0) {
                        if (polyline) {
                            map.removeLayer(polyline); // Ta bort tidigare polyline om det finns
                        }

                        // Lägg till en polyline för att visa flygrutten
                        polyline = L.polyline(coordinates, { color: 'blue' }).addTo(map);

                        // Lägg till en markering för flygplanets position
                        addMarker(latestTrack);

                        // Zooma inte in så mycket efter att ha skrivit in ett callsign
                        map.setView(coordinates[0], 6); // Sätt zoomnivån till 6 istället för att passa in rutten
                    }
                }
            })
            .catch(error => console.error('Error fetching flight track data:', error));
        }

        function addMarker(latestTrack) {
            var coordinates = [latestTrack[1], latestTrack[2]]; // [lat, lon]
            var direction = latestTrack[3]; // Använd riktning om det finns

            // Ta bort tidigare markering om den finns
            if (marker) {
                map.removeLayer(marker);
            }

            // Skapa en pil-ikon med hjälp av SVG
            var iconHtml = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icon-tabler-arrow-right">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M5 12h14m-7 -7l7 7l-7 7" />
                </svg>
            `;

            // Skapa en divIcon med den roterade SVG
            var airplaneIcon = L.divIcon({
                className: 'airplane-icon',
                html: iconHtml,
                iconSize: [24, 24], // Ställ in storleken på ikonen
                iconAnchor: [12, 12], // Mittpunkten för ikonen
                popupAnchor: [0, -12], // Popupens ankare
            });

            // Lägg till markeringen på kartan med den riktade ikonen
            marker = L.marker(coordinates, { icon: airplaneIcon }).addTo(map);
        }

        function updateFlightInfo(state) {
            var callsign = state[1]; // callsign är på index 1
            var origin = state[2]; // origin är på index 2
            var destination = state[3]; // destination är på index 3
            document.getElementById('info').innerHTML = `Flight: ${callsign} | Origin: ${origin} | Destination: ${destination}`;
        }
    </script>
</body>
</html>
